<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Work related to the SWOT satellite mission">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Setting up the LISFLOOD-FP Arkansas simulation | My Personal Work Blog</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://kandread.github.io/posts/Setting-up-the-LISFLOOD-FP-Arkansas-simulation/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="description" itemprop="description" content="Work related to the SWOT satellite mission">
<meta name="author" content="Kostas Andreadis">
<link rel="prev" href="../hello-world/" title="Hello world!" type="text/html">
<meta property="og:site_name" content="My Personal Work Blog">
<meta property="og:title" content="Setting up the LISFLOOD-FP Arkansas simulation">
<meta property="og:url" content="https://kandread.github.io/posts/Setting-up-the-LISFLOOD-FP-Arkansas-simulation/">
<meta property="og:description" content="Work related to the SWOT satellite mission">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-12-27T13:43:00-08:00">
<meta property="article:tag" content="lisflood">
<meta property="article:tag" content="swot">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://kandread.github.io/">

                <span id="blog-title">My Personal Work Blog</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>
                </li>
<li>
<a href="../../rss.xml">RSS feed</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="index.rst" id="sourcelink">Source</a>
    </li>
                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Setting up the LISFLOOD-FP Arkansas simulation</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                    Kostas Andreadis
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2016-12-27T13:43:00-08:00" itemprop="datePublished" title="2016-12-27 13:43">2016-12-27 13:43</time></a></p>
                <p class="commentline">        

                    </p>
<p class="sourceline"><a href="index.rst" id="sourcelink">Source</a></p>

                <meta name="description" itemprop="description" content="Work related to the SWOT satellite mission">
</div>
        
    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>We start by downloading the HydroSHEDS <a class="reference external" href="http://earlywarning.usgs.gov/hydrodata/sa_30s_zip_grid/na_dem_30s_grid.zip">elevation DEM</a> and reprojecting it to the World Mercator projection. Additionally we download shapefiles for the basin and rivers from <a class="reference external" href="http://www.nohrsc.noaa.gov/gisdatasets/">NOHRSC</a>.</p>
<!-- TEASER_END -->
<pre class="code shell"><a name="rest_code_91c0870cf35f4328bdd8e0dc2db916ea-1"></a><span class="nb">cd</span> ~/Work/Swot
<a name="rest_code_91c0870cf35f4328bdd8e0dc2db916ea-2"></a>gdalwarp -dstnodata -9999 -t_srs epsg:3395 data/hydrosheds/na_dem_15s/na_dem_15s na_dem.tif
</pre>
<p>Then we extract the extent of the basin shapefile and use those coordinates as the bounding box to generate the Arkansas River basin DEM.</p>
<pre class="code shell"><a name="rest_code_b6ee2e4865c64dbfad4bb816e02dea18-1"></a><span class="nb">cd</span> ~/Work/Swot
<a name="rest_code_b6ee2e4865c64dbfad4bb816e02dea18-2"></a>ogrinfo -al -so ~/Downloads/b_abrfc/arkansas.shp <span class="p">|</span> grep Extent <span class="p">|</span> awk -F<span class="s1">'[(,]'</span> <span class="s1">'{printf("%f %f\n%f %f\n",$2,$5,$4,$3)}'</span> <span class="p">|</span> gdaltransform -s_srs epsg:4326 -t_srs epsg:3395 -output_xy
<a name="rest_code_b6ee2e4865c64dbfad4bb816e02dea18-3"></a>gdal_translate -a_nodata -9999 -projwin -11866240.2704725 4749554.46189774 -10240048.0795739 3922731.2771146 na_dem.tif data/hydrosheds/arkansas_dem.tif
</pre>
<p>Within GRASS GIS, we calculate the flow accumulation and derive a consistent river network using 10,000 km<sup>2</sup>as a drainage area threshold.</p>
<pre class="code shell"><a name="rest_code_3a2426554c364f0abebe271820774b06-1"></a><span class="nb">cd</span> ~/Work/Swot
<a name="rest_code_3a2426554c364f0abebe271820774b06-2"></a>v.in.ogr <span class="nv">in</span><span class="o">=</span>data/arkansas_basin.shp <span class="nv">out</span><span class="o">=</span>basin
<a name="rest_code_3a2426554c364f0abebe271820774b06-3"></a>v.to.rast <span class="nv">in</span><span class="o">=</span>basin <span class="nv">out</span><span class="o">=</span>basin <span class="nv">use</span><span class="o">=</span>val <span class="nv">value</span><span class="o">=</span>1
<a name="rest_code_3a2426554c364f0abebe271820774b06-4"></a>r.in.gdal <span class="nv">in</span><span class="o">=</span>data/hydrosheds/arkansas_dem.tif <span class="nv">out</span><span class="o">=</span>hydrosheds.dem
<a name="rest_code_3a2426554c364f0abebe271820774b06-5"></a>g.region <span class="nv">rast</span><span class="o">=</span>hydrosheds.dem
<a name="rest_code_3a2426554c364f0abebe271820774b06-6"></a>g.region <span class="nv">res</span><span class="o">=</span>1000
<a name="rest_code_3a2426554c364f0abebe271820774b06-7"></a>r.resamp.stats <span class="nv">in</span><span class="o">=</span>hydrosheds.dem <span class="nv">out</span><span class="o">=</span>hydrosheds.elev
<a name="rest_code_3a2426554c364f0abebe271820774b06-8"></a>r.mask basin
<a name="rest_code_3a2426554c364f0abebe271820774b06-9"></a>r.watershed -4 <span class="nv">elev</span><span class="o">=</span>hydrosheds.elev <span class="nv">accum</span><span class="o">=</span>hydrosheds.flowacc <span class="nv">stream</span><span class="o">=</span>hydrosheds.river <span class="nv">drain</span><span class="o">=</span>hydrosheds.flowdir <span class="nv">threshold</span><span class="o">=</span>10000
<a name="rest_code_3a2426554c364f0abebe271820774b06-10"></a>r.mask -r
<a name="rest_code_3a2426554c364f0abebe271820774b06-11"></a>r.out.gdal <span class="nv">in</span><span class="o">=</span>hydrosheds.flowacc <span class="nv">out</span><span class="o">=</span>data/hydrosheds/arkansas_acc.tif <span class="nv">nodata</span><span class="o">=</span>-9999
<a name="rest_code_3a2426554c364f0abebe271820774b06-12"></a>r.out.gdal <span class="nv">in</span><span class="o">=</span>hydrosheds.flowdir <span class="nv">out</span><span class="o">=</span>data/hydrosheds/arkansas_flowdir.tif <span class="nv">nodata</span><span class="o">=</span>-9999
<a name="rest_code_3a2426554c364f0abebe271820774b06-13"></a>r.out.gdal <span class="nv">type</span><span class="o">=</span>Float64 <span class="nv">in</span><span class="o">=</span>hydrosheds.elev <span class="nv">out</span><span class="o">=</span>data/hydrosheds/arkansas_elev.tif <span class="nv">nodata</span><span class="o">=</span>-9999
</pre>
<p>Then we import the width and depth <a class="reference external" href="https://zenodo.org/record/61758#.WF8A57YrKRs">database</a> and attach the attributes to the nearest river segment in the derived network.</p>
<pre class="code shell"><a name="rest_code_28b3c8d3c76e47babcc22fa0963c5a85-1"></a><span class="nb">cd</span> ~/Work/Swot
<a name="rest_code_28b3c8d3c76e47babcc22fa0963c5a85-2"></a>ogr2ogr -t_srs epsg:3395 -clipdst -11866240.2704725 3922731.2771146 -10240048.0795739 4749554.46189774 rivs.shp data/hydrosheds/nariv.shp
<a name="rest_code_28b3c8d3c76e47babcc22fa0963c5a85-3"></a>v.in.ogr -r <span class="nv">in</span><span class="o">=</span>rivs.shp <span class="nv">out</span><span class="o">=</span>nariv <span class="nv">where</span><span class="o">=</span><span class="s1">'AREA&gt;10000'</span>
<a name="rest_code_28b3c8d3c76e47babcc22fa0963c5a85-4"></a>r.to.vect <span class="nv">in</span><span class="o">=</span>hydrosheds.river <span class="nv">out</span><span class="o">=</span>river <span class="nv">type</span><span class="o">=</span>line
<a name="rest_code_28b3c8d3c76e47babcc22fa0963c5a85-5"></a>v.db.addcolumn <span class="nv">map</span><span class="o">=</span>river <span class="nv">col</span><span class="o">=</span><span class="s1">'width real'</span>
<a name="rest_code_28b3c8d3c76e47babcc22fa0963c5a85-6"></a>v.db.addcolumn <span class="nv">map</span><span class="o">=</span>river <span class="nv">col</span><span class="o">=</span><span class="s1">'depth real'</span>
<a name="rest_code_28b3c8d3c76e47babcc22fa0963c5a85-7"></a>v.distance <span class="nv">from</span><span class="o">=</span>river <span class="nv">to</span><span class="o">=</span>nariv <span class="nv">upload</span><span class="o">=</span>to_attr <span class="nv">to_column</span><span class="o">=</span>DEPTH <span class="nv">column</span><span class="o">=</span>depth
<a name="rest_code_28b3c8d3c76e47babcc22fa0963c5a85-8"></a>v.distance <span class="nv">from</span><span class="o">=</span>river <span class="nv">to</span><span class="o">=</span>nariv <span class="nv">upload</span><span class="o">=</span>to_attr <span class="nv">to_column</span><span class="o">=</span>WIDTH <span class="nv">column</span><span class="o">=</span>width
</pre>
<p>Now we rasterize the river vector to get the width and depth rasters.</p>
<pre class="code shell"><a name="rest_code_d6df54f4ba2e4bd2bea077b047447b75-1"></a><span class="nb">cd</span> ~/Work/Swot
<a name="rest_code_d6df54f4ba2e4bd2bea077b047447b75-2"></a>v.out.ogr <span class="nv">in</span><span class="o">=</span>river <span class="nv">out</span><span class="o">=</span>river.shp
<a name="rest_code_d6df54f4ba2e4bd2bea077b047447b75-3"></a>gdal_rasterize -tr <span class="m">1000</span> -1000 -te -11866312.89618489 3922978.04043566 -10239890.36676315 4749955.88036534 -a_srs epsg:3395 -a width river.shp data/hydrosheds/arkansas_widths.tif
<a name="rest_code_d6df54f4ba2e4bd2bea077b047447b75-4"></a>gdal_rasterize -tr <span class="m">1000</span> -1000 -te -11866312.89618489 3922978.04043566 -10239890.36676315 4749955.88036534 -a_srs epsg:3395 -a depth river.shp data/hydrosheds/arkansas_depths.tif
</pre>
<p>The next steps involve preparing the actual LISFLOOD-FP input files. Given the uncertainty in the DEM, we will smooth the river bank heights to avoid any numerical instabilities during simulation.
This is accomplished by first identifying the upstream and downstream boundary points in the domain, labeling the river channels and calculating each one's chainage (i.e. distance downstream).</p>
<pre class="code ipython"><a name="rest_code_09d3e0d5a4ef4ed68ec08d56f2b0308f-1"></a><span class="kn">import</span> <span class="nn">sys</span>
<a name="rest_code_09d3e0d5a4ef4ed68ec08d56f2b0308f-2"></a><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/scripts"</span><span class="p">)</span>
<a name="rest_code_09d3e0d5a4ef4ed68ec08d56f2b0308f-3"></a><span class="kn">import</span> <span class="nn">lisflood</span>
<a name="rest_code_09d3e0d5a4ef4ed68ec08d56f2b0308f-4"></a><span class="n">flowdir</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">read_raster</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_flowdir.tif"</span><span class="p">)</span>
<a name="rest_code_09d3e0d5a4ef4ed68ec08d56f2b0308f-5"></a><span class="n">flowacc</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">read_raster</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_acc.tif"</span><span class="p">)</span>
<a name="rest_code_09d3e0d5a4ef4ed68ec08d56f2b0308f-6"></a><span class="n">widths</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">read_raster</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_widths.tif"</span><span class="p">)</span>
<a name="rest_code_09d3e0d5a4ef4ed68ec08d56f2b0308f-7"></a><span class="n">river</span> <span class="o">=</span> <span class="n">widths</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a name="rest_code_09d3e0d5a4ef4ed68ec08d56f2b0308f-8"></a><span class="n">bndpts</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">find_boundary_points</span><span class="p">(</span><span class="n">river</span><span class="p">)</span>
<a name="rest_code_09d3e0d5a4ef4ed68ec08d56f2b0308f-9"></a><span class="n">labels</span><span class="p">,</span> <span class="n">chainage</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">calc_chainage</span><span class="p">(</span><span class="n">river</span><span class="p">,</span> <span class="n">flowdir</span><span class="p">,</span> <span class="n">flowacc</span><span class="p">,</span> <span class="n">bndpts</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</pre>
<p>The smoothing of the bank heights is done by using a <a class="reference external" href="http://statsmodels.sourceforge.net/devel/generated/statsmodels.nonparametric.smoothers_lowess.lowess.html">LOWESS</a> local regression, and the channel is burned in to the DEM by subtracting the depth raster.</p>
<pre class="code ipython"><a name="rest_code_f9a71a7310b94cfd9d088e165d7a7431-1"></a><span class="n">elev</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">read_raster</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_elev.tif"</span><span class="p">)</span>
<a name="rest_code_f9a71a7310b94cfd9d088e165d7a7431-2"></a><span class="n">depths</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">read_raster</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_depths.tif"</span><span class="p">)</span>
<a name="rest_code_f9a71a7310b94cfd9d088e165d7a7431-3"></a><span class="n">depths</span><span class="p">[</span><span class="n">depths</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="rest_code_f9a71a7310b94cfd9d088e165d7a7431-4"></a><span class="n">selev</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">smooth_bank_heights</span><span class="p">(</span><span class="n">elev</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">chainage</span><span class="p">)</span>
<a name="rest_code_f9a71a7310b94cfd9d088e165d7a7431-5"></a><span class="n">belev</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">burn_channel</span><span class="p">(</span><span class="n">selev</span><span class="p">,</span> <span class="n">river</span><span class="p">,</span> <span class="n">depths</span><span class="p">)</span>
<a name="rest_code_f9a71a7310b94cfd9d088e165d7a7431-6"></a><span class="n">lisflood</span><span class="o">.</span><span class="n">write_raster</span><span class="p">(</span><span class="n">belev</span><span class="p">,</span> <span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_belev.tif"</span><span class="p">,</span> <span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_elev.tif"</span><span class="p">)</span>
</pre>
<p>As an example, the problems of the HydroSHEDS DEM are obvious in the figure below as well as the impact of the smoothing to create the channel.</p>
<pre class="code ipython"><a name="rest_code_a511a4840607492b805375168e158db5-1"></a><span class="o">%</span><span class="k">matplotlib</span> inline
<a name="rest_code_a511a4840607492b805375168e158db5-2"></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<a name="rest_code_a511a4840607492b805375168e158db5-3"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<a name="rest_code_a511a4840607492b805375168e158db5-4"></a><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">chainage</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">elev</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">chainage</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"HydroSHEDS"</span><span class="p">)</span>
<a name="rest_code_a511a4840607492b805375168e158db5-5"></a><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">chainage</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">belev</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">chainage</span><span class="p">[</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Smoothed"</span><span class="p">)</span>
<a name="rest_code_a511a4840607492b805375168e158db5-6"></a><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">"Chainage (km)"</span><span class="p">)</span>
<a name="rest_code_a511a4840607492b805375168e158db5-7"></a><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">"Elevation (m)"</span><span class="p">)</span>
<a name="rest_code_a511a4840607492b805375168e158db5-8"></a><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<a name="rest_code_a511a4840607492b805375168e158db5-9"></a><span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">335</span><span class="p">,</span> <span class="mi">365</span><span class="p">])</span>
<a name="rest_code_a511a4840607492b805375168e158db5-10"></a><span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">920</span><span class="p">,</span> <span class="mi">970</span><span class="p">])</span>
<a name="rest_code_a511a4840607492b805375168e158db5-11"></a><span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre>
<img alt="/images/banksmooth.png" src="../../images/banksmooth.png"><p>Next we identify the upstream and lateral inflow points, and generate the BCI file.</p>
<pre class="code ipython"><a name="rest_code_1b28004c5a824cae846b6de262962df6-1"></a><span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span>
<a name="rest_code_1b28004c5a824cae846b6de262962df6-2"></a><span class="n">inflows</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">identify_inflows</span><span class="p">(</span><span class="n">river</span><span class="p">,</span> <span class="n">chainage</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">flowacc</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
<a name="rest_code_1b28004c5a824cae846b6de262962df6-3"></a><span class="n">f</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_elev.tif"</span><span class="p">)</span>
<a name="rest_code_1b28004c5a824cae846b6de262962df6-4"></a><span class="n">xul</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">yul</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
<a name="rest_code_1b28004c5a824cae846b6de262962df6-5"></a><span class="n">f</span> <span class="o">=</span> <span class="bp">None</span>
<a name="rest_code_1b28004c5a824cae846b6de262962df6-6"></a><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">elev</span><span class="o">.</span><span class="n">shape</span>
<a name="rest_code_1b28004c5a824cae846b6de262962df6-7"></a><span class="n">lisflood</span><span class="o">.</span><span class="n">write_bci</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/input/arkansas.bci"</span><span class="p">,</span> <span class="n">inflows</span><span class="p">,</span> <span class="n">xul</span><span class="p">,</span> <span class="n">yul</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
</pre>
<p>Then we generate the DEM and sub-grid channel width files.</p>
<pre class="code shell"><a name="rest_code_a46769ea0104420dae2d074eca8e5234-1"></a><span class="nb">cd</span> ~/Work/Swot
<a name="rest_code_a46769ea0104420dae2d074eca8e5234-2"></a>gdal_translate -tr <span class="m">1000</span> -1000 -of AAIGrid -a_nodata -9999 data/hydrosheds/arkansas_belev.tif input/arkansas.dem
<a name="rest_code_a46769ea0104420dae2d074eca8e5234-3"></a>gdal_translate -tr <span class="m">1000</span> -1000 -of AAIGrid -a_nodata -9999 data/hydrosheds/arkansas_widths.tif input/arkansas.width
</pre>
<p>If we need LISFLOOD-FP to produce a time series of river flow at specific locations, we need to generate a virtual gauge file.</p>
<pre class="code ipython"><a name="rest_code_82c419603803482fbad6683a98424421-1"></a><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">10646593</span><span class="p">,</span> <span class="o">-</span><span class="mi">10280351</span><span class="p">]</span>
<a name="rest_code_82c419603803482fbad6683a98424421-2"></a><span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4251217</span><span class="p">,</span> <span class="mi">4111394</span><span class="p">]</span>
<a name="rest_code_82c419603803482fbad6683a98424421-3"></a><span class="n">lisflood</span><span class="o">.</span><span class="n">write_gauges</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">chainage</span><span class="p">,</span> <span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_widths.tif"</span><span class="p">,</span> <span class="s2">"/Users/kandread/Work/Swot/input/arkansas.gauge"</span><span class="p">)</span>
</pre>
<p>The final step is generating the BDY file for LISFLOOD-FP, which contains the streamflow at the inflow points (in m<sup>2</sup>/s). For this simulation we will use the output of the <a class="reference external" href="https://github.com/UW-Hydro/VIC_Routing">VIC routing model</a> forced by the <a class="reference external" href="http://ldas.gsfc.nasa.gov/nldas/NLDAS2model.php">NLDAS-2 VIC model output</a>. We need to prepare the input files for the routing model, describing the flow direction, flow fraction and station locations.
Within GRASS GIS, we create a new region with Lat/Long projection and work within that region to create the necessary files.</p>
<pre class="code shell"><a name="rest_code_afd8b80b84204da1b37011fa03466471-1"></a>g.proj <span class="nv">epsg</span><span class="o">=</span><span class="m">4326</span> <span class="nv">location</span><span class="o">=</span>arkansas.latlon
<a name="rest_code_afd8b80b84204da1b37011fa03466471-2"></a>g.mapset <span class="nv">mapset</span><span class="o">=</span>PERMANENT <span class="nv">location</span><span class="o">=</span>arkansas.latlon
<a name="rest_code_afd8b80b84204da1b37011fa03466471-3"></a>g.region <span class="nv">n</span><span class="o">=</span>39.5 <span class="nv">s</span><span class="o">=</span>32.25 <span class="nv">e</span><span class="o">=</span>-91.875 <span class="nv">w</span><span class="o">=</span>-106.75 <span class="nv">res</span><span class="o">=</span>0:00:30
<a name="rest_code_afd8b80b84204da1b37011fa03466471-4"></a>r.proj <span class="nv">mapset</span><span class="o">=</span>arkansas <span class="nv">location</span><span class="o">=</span>arkansas <span class="nv">in</span><span class="o">=</span>hydrosheds.elev <span class="nv">method</span><span class="o">=</span>bilinear
<a name="rest_code_afd8b80b84204da1b37011fa03466471-5"></a>r.proj <span class="nv">mapset</span><span class="o">=</span>arkansas <span class="nv">location</span><span class="o">=</span>arkansas <span class="nv">in</span><span class="o">=</span>basin
<a name="rest_code_afd8b80b84204da1b37011fa03466471-6"></a>r.mapcalc <span class="nv">exp</span><span class="o">=</span><span class="s1">'basin1=if(isnull(basin),0,1)'</span>
<a name="rest_code_afd8b80b84204da1b37011fa03466471-7"></a>g.region <span class="nv">res</span><span class="o">=</span>0.125
<a name="rest_code_afd8b80b84204da1b37011fa03466471-8"></a>r.watershed -s <span class="nv">elev</span><span class="o">=</span>hydrosheds.elev <span class="nv">accum</span><span class="o">=</span>hydrosheds.flowacc <span class="nv">drain</span><span class="o">=</span>hydrosheds.flowdir
<a name="rest_code_afd8b80b84204da1b37011fa03466471-9"></a>r.resamp.stats <span class="nv">in</span><span class="o">=</span>basin1 <span class="nv">out</span><span class="o">=</span>fract
<a name="rest_code_afd8b80b84204da1b37011fa03466471-10"></a>r.reclass <span class="nv">in</span><span class="o">=</span>hydrosheds.flowdir <span class="nv">out</span><span class="o">=</span>flowdir <span class="nv">rules</span><span class="o">=</span>flowdir.rules
<a name="rest_code_afd8b80b84204da1b37011fa03466471-11"></a>r.mapcalc --o <span class="nv">exp</span><span class="o">=</span><span class="s1">'flowdir=flowdir'</span>
<a name="rest_code_afd8b80b84204da1b37011fa03466471-12"></a>r.null <span class="nv">map</span><span class="o">=</span>flowdir <span class="nv">setnull</span><span class="o">=</span>0
<a name="rest_code_afd8b80b84204da1b37011fa03466471-13"></a>r.null <span class="nv">map</span><span class="o">=</span>fract <span class="nv">null</span><span class="o">=</span>0
<a name="rest_code_afd8b80b84204da1b37011fa03466471-14"></a>r.out.gdal <span class="nv">in</span><span class="o">=</span>fract <span class="nv">out</span><span class="o">=</span>arkansas.fract <span class="nv">format</span><span class="o">=</span>AAIGrid <span class="nv">nodata</span><span class="o">=</span>0
<a name="rest_code_afd8b80b84204da1b37011fa03466471-15"></a>r.out.gdal <span class="nv">in</span><span class="o">=</span>flowdir <span class="nv">out</span><span class="o">=</span>arkansas.flowdir <span class="nv">format</span><span class="o">=</span>AAIGrid <span class="nv">nodata</span><span class="o">=</span>0
</pre>
<p>The station file is created from the inflows identified</p>
<pre class="code ipython"><a name="rest_code_c54632982a854e31a0935d8921d22f66-1"></a><span class="kn">from</span> <span class="nn">pyproj</span> <span class="kn">import</span> <span class="n">Proj</span>
<a name="rest_code_c54632982a854e31a0935d8921d22f66-2"></a><span class="n">wmerc</span> <span class="o">=</span> <span class="n">Proj</span><span class="p">(</span><span class="s2">"+init=EPSG:3395"</span><span class="p">)</span>
<a name="rest_code_c54632982a854e31a0935d8921d22f66-3"></a><span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"arkansas.stations"</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span>
<a name="rest_code_c54632982a854e31a0935d8921d22f66-4"></a><span class="k">for</span> <span class="n">sta</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inflows</span><span class="p">):</span>
<a name="rest_code_c54632982a854e31a0935d8921d22f66-5"></a>    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">wmerc</span><span class="p">(</span><span class="n">xul</span><span class="o">+</span><span class="n">xres</span><span class="o">*</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yul</span><span class="o">+</span><span class="n">yres</span><span class="o">*</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<a name="rest_code_c54632982a854e31a0935d8921d22f66-6"></a>    <span class="n">xi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x</span><span class="o">+</span><span class="mf">106.75</span><span class="p">)</span><span class="o">/</span><span class="mf">0.125</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="rest_code_c54632982a854e31a0935d8921d22f66-7"></a>    <span class="n">yi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="mf">32.25</span><span class="p">)</span><span class="o">/</span><span class="mf">0.125</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="rest_code_c54632982a854e31a0935d8921d22f66-8"></a>    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"1</span><span class="se">\t</span><span class="s2">AR{0:03d}</span><span class="se">\t</span><span class="s2">{1}</span><span class="se">\t</span><span class="s2">{2}</span><span class="se">\t</span><span class="s2">-9999</span><span class="se">\n</span><span class="s2">NONE</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">))</span>
<a name="rest_code_c54632982a854e31a0935d8921d22f66-9"></a><span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
<p>Finally, the BDY file is written using the VIC routing model's output.</p>
<pre class="code ipython"><a name="rest_code_eb077db14f2f442badbe774471d7f834-1"></a><span class="n">stations</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"AR{0:03d}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inflows</span><span class="p">)]</span>
<a name="rest_code_eb077db14f2f442badbe774471d7f834-2"></a><span class="n">lisflood</span><span class="o">.</span><span class="n">write_bdy</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/input/arkansas.bdy"</span><span class="p">,</span> <span class="s2">"/Volumes/External2/nldas2"</span><span class="p">,</span> <span class="n">stations</span><span class="p">)</span>
</pre>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/lisflood/" rel="tag">lisflood</a></li>
            <li><a class="tag p-category" href="../../categories/swot/" rel="tag">swot</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../hello-world/" rel="prev" title="Hello world!">Previous post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
                

        </section></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2016         <a href="mailto:kandread@jpl.nasa.gov">Kostas Andreadis</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>

            <script src="../../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
