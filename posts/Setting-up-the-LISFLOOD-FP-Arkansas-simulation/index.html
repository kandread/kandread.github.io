<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " vocab="http://ogp.me/ns" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Setting up the LISFLOOD-FP Arkansas simulation | My Personal Work Blog</title>
<link href="../../assets/css/all.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="//fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://kandread.github.io/posts/Setting-up-the-LISFLOOD-FP-Arkansas-simulation/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Kostas Andreadis">
<link rel="prev" href="../hello-world/" title="Hello world!" type="text/html">
<meta property="og:site_name" content="My Personal Work Blog">
<meta property="og:title" content="Setting up the LISFLOOD-FP Arkansas simulation">
<meta property="og:url" content="https://kandread.github.io/posts/Setting-up-the-LISFLOOD-FP-Arkansas-simulation/">
<meta property="og:description" content="We start by downloading the HydroSHEDS elevation DEM and reprojecting it to the World Mercator projection. Additionally we download shapefiles for the basin and rivers from NOHRSC.

cd ~/Work/Swot
gda">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-12-27T13:43:00-08:00">
<meta property="article:tag" content="lisflood">
<meta property="article:tag" content="swot">
</head>
<body class="theme-base-0d">
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
            styles, `#sidebar-checkbox` for behavior. -->
    <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"><!-- Toggleable sidebar --><div class="sidebar" id="sidebar">
        <div class="sidebar-item">
            <p>A reserved <a href="https://getnikola.com" target="_blank">Nikola</a> theme that places the utmost gravity on content with a hidden drawer. Made by <a href="https://twitter.com/mdo" target="_blank">@mdo</a> for Jekyll,
            ported to Nikola by <a href="https://twitter.com/ralsina" target="_blank">@ralsina</a>.</p>
        </div>
        
    <nav id="menu" role="navigation" class="sidebar-nav"><a class="sidebar-nav-item" href="../../archive.html">Archive</a>
        <a class="sidebar-nav-item" href="../../categories/">Tags</a>
        <a class="sidebar-nav-item" href="../../rss.xml">RSS feed</a>
    
    
    </nav>
</div>

    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          
    <h3 id="brand" class="masthead-title">
      <a href="https://kandread.github.io/" title="My Personal Work Blog" rel="home">My Personal Work Blog</a>
    </h3>

        </div>
      </div>

      <div class="container content" id="content">
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="post-title p-name entry-title" itemprop="headline name"><a href="." class="u-url">Setting up the LISFLOOD-FP Arkansas simulation</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">Kostas Andreadis</span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="post-date published dt-published" datetime="2016-12-27T13:43:00-08:00" itemprop="datePublished" title="2016-12-27 13:43">2016-12-27 13:43</time></a></p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/setting-up-the-arkansas-lisflood-fp-simulation.html">Comments</a>


        </p>
</div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<p>We start by downloading the HydroSHEDS <a class="reference external" href="http://earlywarning.usgs.gov/hydrodata/sa_30s_zip_grid/na_dem_30s_grid.zip">elevation DEM</a> and reprojecting it to the World Mercator projection. Additionally we download shapefiles for the basin and rivers from <a class="reference external" href="http://www.nohrsc.noaa.gov/gisdatasets/">NOHRSC</a>.</p>
<!-- TEASER_END -->
<pre class="code shell"><a name="rest_code_a1bedf57d974455a8536dfd44e194665-1"></a><span class="nb">cd</span> ~/Work/Swot
<a name="rest_code_a1bedf57d974455a8536dfd44e194665-2"></a>gdalwarp -dstnodata -9999 -t_srs epsg:3395 data/hydrosheds/na_dem_15s/na_dem_15s na_dem.tif
</pre>
<p>Then we extract the extent of the basin shapefile and use those coordinates as the bounding box to generate the Arkansas River basin DEM.</p>
<pre class="code shell"><a name="rest_code_0705b62188f642fbb3739d32b353afa7-1"></a><span class="nb">cd</span> ~/Work/Swot
<a name="rest_code_0705b62188f642fbb3739d32b353afa7-2"></a>ogrinfo -al -so ~/Downloads/b_abrfc/arkansas.shp <span class="p">|</span> grep Extent <span class="p">|</span> awk -F<span class="s1">'[(,]'</span> <span class="s1">'{printf("%f %f\n%f %f\n",$2,$5,$4,$3)}'</span> <span class="p">|</span> gdaltransform -s_srs epsg:4326 -t_srs epsg:3395 -output_xy
<a name="rest_code_0705b62188f642fbb3739d32b353afa7-3"></a>gdal_translate -a_nodata -9999 -projwin -11866240.2704725 <span class="m">4749554</span>.46189774 -10240048.0795739 <span class="m">3922731</span>.2771146 na_dem.tif data/hydrosheds/arkansas_dem.tif
</pre>
<p>Within GRASS GIS, we calculate the flow accumulation and derive a consistent river network using 10,000 km<sup>2</sup>as a drainage area threshold. Before deriving the river network we create a depressionless DEM (i.e. hydrologic conditioning).</p>
<pre class="code shell"><a name="rest_code_7bed7b5d3154433cbf996d272631e98e-1"></a><span class="nb">cd</span> ~/Work/Swot
<a name="rest_code_7bed7b5d3154433cbf996d272631e98e-2"></a>v.in.ogr <span class="nv">in</span><span class="o">=</span>data/arkansas_basin.shp <span class="nv">out</span><span class="o">=</span>basin
<a name="rest_code_7bed7b5d3154433cbf996d272631e98e-3"></a>v.to.rast <span class="nv">in</span><span class="o">=</span>basin <span class="nv">out</span><span class="o">=</span>basin <span class="nv">use</span><span class="o">=</span>val <span class="nv">value</span><span class="o">=</span><span class="m">1</span>
<a name="rest_code_7bed7b5d3154433cbf996d272631e98e-4"></a>r.in.gdal <span class="nv">in</span><span class="o">=</span>data/hydrosheds/arkansas_dem.tif <span class="nv">out</span><span class="o">=</span>hydrosheds.dem
<a name="rest_code_7bed7b5d3154433cbf996d272631e98e-5"></a>g.region <span class="nv">rast</span><span class="o">=</span>hydrosheds.dem
<a name="rest_code_7bed7b5d3154433cbf996d272631e98e-6"></a>g.region <span class="nv">res</span><span class="o">=</span><span class="m">1000</span>
<a name="rest_code_7bed7b5d3154433cbf996d272631e98e-7"></a>r.resamp.stats <span class="nv">in</span><span class="o">=</span>hydrosheds.dem <span class="nv">out</span><span class="o">=</span>hydrosheds.elev <span class="nv">method</span><span class="o">=</span>minimum
<a name="rest_code_7bed7b5d3154433cbf996d272631e98e-8"></a>r.hydrodem -a <span class="nv">in</span><span class="o">=</span>hydrosheds.elev <span class="nv">out</span><span class="o">=</span>hydrosheds.felev
<a name="rest_code_7bed7b5d3154433cbf996d272631e98e-9"></a>r.watershed -s <span class="nv">elev</span><span class="o">=</span>hydrosheds.felev <span class="nv">accum</span><span class="o">=</span>hydrosheds.flowacc <span class="nv">stream</span><span class="o">=</span>hydrosheds.river <span class="nv">drain</span><span class="o">=</span>hydrosheds.flowdir <span class="nv">threshold</span><span class="o">=</span><span class="m">10000</span>
<a name="rest_code_7bed7b5d3154433cbf996d272631e98e-10"></a>r.out.gdal <span class="nv">in</span><span class="o">=</span>hydrosheds.flowacc <span class="nv">out</span><span class="o">=</span>data/hydrosheds/arkansas_acc.tif <span class="nv">nodata</span><span class="o">=</span>-9999
<a name="rest_code_7bed7b5d3154433cbf996d272631e98e-11"></a>r.out.gdal <span class="nv">in</span><span class="o">=</span>hydrosheds.flowdir <span class="nv">out</span><span class="o">=</span>data/hydrosheds/arkansas_flowdir.tif <span class="nv">nodata</span><span class="o">=</span>-9999
<a name="rest_code_7bed7b5d3154433cbf996d272631e98e-12"></a>r.out.gdal <span class="nv">type</span><span class="o">=</span>Float64 <span class="nv">in</span><span class="o">=</span>hydrosheds.felev <span class="nv">out</span><span class="o">=</span>data/hydrosheds/arkansas_elev.tif <span class="nv">nodata</span><span class="o">=</span>-9999
</pre>
<p>Then we import the width and depth <a class="reference external" href="https://zenodo.org/record/61758#.WF8A57YrKRs">database</a> and attach the attributes to the nearest river segment in the derived network.</p>
<pre class="code shell"><a name="rest_code_030abe53b6a44c4ab1aafe70bb7ceb4e-1"></a><span class="nb">cd</span> ~/Work/Swot
<a name="rest_code_030abe53b6a44c4ab1aafe70bb7ceb4e-2"></a>ogr2ogr -t_srs epsg:3395 -clipdst -11866240.2704725 <span class="m">3922731</span>.2771146 -10240048.0795739 <span class="m">4749554</span>.46189774 rivs.shp data/hydrosheds/nariv.shp
<a name="rest_code_030abe53b6a44c4ab1aafe70bb7ceb4e-3"></a>v.in.ogr -r <span class="nv">in</span><span class="o">=</span>rivs.shp <span class="nv">out</span><span class="o">=</span>nariv <span class="nv">where</span><span class="o">=</span><span class="s1">'AREA&gt;10000'</span>
<a name="rest_code_030abe53b6a44c4ab1aafe70bb7ceb4e-4"></a>r.mask basin
<a name="rest_code_030abe53b6a44c4ab1aafe70bb7ceb4e-5"></a>r.to.vect <span class="nv">in</span><span class="o">=</span>hydrosheds.river <span class="nv">out</span><span class="o">=</span>river <span class="nv">type</span><span class="o">=</span>line -s
<a name="rest_code_030abe53b6a44c4ab1aafe70bb7ceb4e-6"></a>r.mask -r
<a name="rest_code_030abe53b6a44c4ab1aafe70bb7ceb4e-7"></a>v.db.addcolumn <span class="nv">map</span><span class="o">=</span>river <span class="nv">col</span><span class="o">=</span><span class="s1">'width real'</span>
<a name="rest_code_030abe53b6a44c4ab1aafe70bb7ceb4e-8"></a>v.db.addcolumn <span class="nv">map</span><span class="o">=</span>river <span class="nv">col</span><span class="o">=</span><span class="s1">'depth real'</span>
<a name="rest_code_030abe53b6a44c4ab1aafe70bb7ceb4e-9"></a>v.distance <span class="nv">from</span><span class="o">=</span>river <span class="nv">to</span><span class="o">=</span>nariv <span class="nv">upload</span><span class="o">=</span>to_attr <span class="nv">to_column</span><span class="o">=</span>DEPTH <span class="nv">column</span><span class="o">=</span>depth
<a name="rest_code_030abe53b6a44c4ab1aafe70bb7ceb4e-10"></a>v.distance <span class="nv">from</span><span class="o">=</span>river <span class="nv">to</span><span class="o">=</span>nariv <span class="nv">upload</span><span class="o">=</span>to_attr <span class="nv">to_column</span><span class="o">=</span>WIDTH <span class="nv">column</span><span class="o">=</span>width
</pre>
<p>Now we rasterize the river vector to get the width and depth rasters.</p>
<pre class="code shell"><a name="rest_code_6c4e15ad18b74e7b889fe1e86c4a03aa-1"></a><span class="nb">cd</span> ~/Work/Swot
<a name="rest_code_6c4e15ad18b74e7b889fe1e86c4a03aa-2"></a>v.to.rast <span class="nv">in</span><span class="o">=</span>river <span class="nv">out</span><span class="o">=</span>hydrosheds.width <span class="nv">use</span><span class="o">=</span>attr <span class="nv">attribute_column</span><span class="o">=</span>width
<a name="rest_code_6c4e15ad18b74e7b889fe1e86c4a03aa-3"></a>v.to.rast <span class="nv">in</span><span class="o">=</span>river <span class="nv">out</span><span class="o">=</span>hydrosheds.depth <span class="nv">use</span><span class="o">=</span>attr <span class="nv">attribute_column</span><span class="o">=</span>depth
<a name="rest_code_6c4e15ad18b74e7b889fe1e86c4a03aa-4"></a>r.out.gdal <span class="nv">in</span><span class="o">=</span>hydrosheds.width <span class="nv">out</span><span class="o">=</span>data/hydrosheds/arkansas_widths.tif <span class="nv">nodata</span><span class="o">=</span>-9999
<a name="rest_code_6c4e15ad18b74e7b889fe1e86c4a03aa-5"></a>r.out.gdal <span class="nv">in</span><span class="o">=</span>hydrosheds.depth <span class="nv">out</span><span class="o">=</span>data/hydrosheds/arkansas_depths.tif <span class="nv">nodata</span><span class="o">=</span>-9999
</pre>
<p>The next steps involve preparing the actual LISFLOOD-FP input files. Given the uncertainty in the DEM, we will smooth the river bank heights to avoid any numerical instabilities during simulation.
This is accomplished by first identifying the upstream and downstream boundary points in the domain, labeling the river channels and calculating each one's chainage (i.e. distance downstream).</p>
<pre class="code ipython"><a name="rest_code_c1bd4382b9b84a0a8f9f3d413b90b8ff-1"></a><span class="kn">import</span> <span class="nn">sys</span>
<a name="rest_code_c1bd4382b9b84a0a8f9f3d413b90b8ff-2"></a><span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/scripts"</span><span class="p">)</span>
<a name="rest_code_c1bd4382b9b84a0a8f9f3d413b90b8ff-3"></a><span class="kn">import</span> <span class="nn">lisflood</span>
<a name="rest_code_c1bd4382b9b84a0a8f9f3d413b90b8ff-4"></a><span class="n">flowdir</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">read_raster</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_flowdir.tif"</span><span class="p">)</span>
<a name="rest_code_c1bd4382b9b84a0a8f9f3d413b90b8ff-5"></a><span class="n">flowacc</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">read_raster</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_acc.tif"</span><span class="p">)</span>
<a name="rest_code_c1bd4382b9b84a0a8f9f3d413b90b8ff-6"></a><span class="n">widths</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">read_raster</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_widths.tif"</span><span class="p">)</span>
<a name="rest_code_c1bd4382b9b84a0a8f9f3d413b90b8ff-7"></a><span class="n">river</span> <span class="o">=</span> <span class="n">widths</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a name="rest_code_c1bd4382b9b84a0a8f9f3d413b90b8ff-8"></a><span class="n">bndpts</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">find_boundary_points</span><span class="p">(</span><span class="n">river</span><span class="p">,</span> <span class="n">flowdir</span><span class="p">)</span>
<a name="rest_code_c1bd4382b9b84a0a8f9f3d413b90b8ff-9"></a><span class="n">labels</span><span class="p">,</span> <span class="n">chainage</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">calc_chainage</span><span class="p">(</span><span class="n">river</span><span class="p">,</span> <span class="n">flowdir</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">flowacc</span><span class="p">),</span> <span class="n">bndpts</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
</pre>
<p>The smoothing of the bank heights is done by using a <a class="reference external" href="http://statsmodels.sourceforge.net/devel/generated/statsmodels.nonparametric.smoothers_lowess.lowess.html">LOWESS</a> local regression, and the channel is burned in to the DEM by subtracting the depth raster.</p>
<pre class="code ipython"><a name="rest_code_9c0f29afd069449c93913beadea62712-1"></a><span class="n">elev</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">read_raster</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_elev.tif"</span><span class="p">)</span>
<a name="rest_code_9c0f29afd069449c93913beadea62712-2"></a><span class="n">selev</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">smooth_bank_heights</span><span class="p">(</span><span class="n">elev</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">chainage</span><span class="p">)</span>
<a name="rest_code_9c0f29afd069449c93913beadea62712-3"></a><span class="n">lisflood</span><span class="o">.</span><span class="n">write_raster</span><span class="p">(</span><span class="n">selev</span><span class="p">,</span> <span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_selev.tif"</span><span class="p">,</span> <span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_elev.tif"</span><span class="p">)</span>
<a name="rest_code_9c0f29afd069449c93913beadea62712-4"></a><span class="n">depths</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">read_raster</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_depths.tif"</span><span class="p">)</span>
<a name="rest_code_9c0f29afd069449c93913beadea62712-5"></a><span class="n">depths</span><span class="p">[</span><span class="n">depths</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="rest_code_9c0f29afd069449c93913beadea62712-6"></a><span class="n">belev</span> <span class="o">=</span> <span class="n">selev</span> <span class="o">-</span> <span class="n">depths</span>
<a name="rest_code_9c0f29afd069449c93913beadea62712-7"></a><span class="n">lisflood</span><span class="o">.</span><span class="n">write_raster</span><span class="p">(</span><span class="n">belev</span><span class="p">,</span> <span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_bed.tif"</span><span class="p">,</span> <span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_elev.tif"</span><span class="p">)</span>
<a name="rest_code_9c0f29afd069449c93913beadea62712-8"></a><span class="n">y0</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">depths</span>
<a name="rest_code_9c0f29afd069449c93913beadea62712-9"></a><span class="n">y0</span><span class="p">[</span><span class="n">widths</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="rest_code_9c0f29afd069449c93913beadea62712-10"></a><span class="n">lisflood</span><span class="o">.</span><span class="n">write_raster</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_initwd.tif"</span><span class="p">,</span> <span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_elev.tif"</span><span class="p">)</span>
</pre>
<p>Next we identify the upstream and lateral inflow points, and generate the BCI file.</p>
<pre class="code ipython"><a name="rest_code_d698d8b9a26c435f8bb3272372adb605-1"></a><span class="kn">from</span> <span class="nn">osgeo</span> <span class="kn">import</span> <span class="n">gdal</span>
<a name="rest_code_d698d8b9a26c435f8bb3272372adb605-2"></a><span class="n">inflows</span> <span class="o">=</span> <span class="n">lisflood</span><span class="o">.</span><span class="n">identify_inflows</span><span class="p">(</span><span class="n">river</span><span class="p">,</span> <span class="n">chainage</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">flowacc</span><span class="p">),</span> <span class="mi">10000</span><span class="p">)</span>
<a name="rest_code_d698d8b9a26c435f8bb3272372adb605-3"></a><span class="n">f</span> <span class="o">=</span> <span class="n">gdal</span><span class="o">.</span><span class="n">Open</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_selev.tif"</span><span class="p">)</span>
<a name="rest_code_d698d8b9a26c435f8bb3272372adb605-4"></a><span class="n">xul</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">yul</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">yres</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">GetGeoTransform</span><span class="p">()</span>
<a name="rest_code_d698d8b9a26c435f8bb3272372adb605-5"></a><span class="n">f</span> <span class="o">=</span> <span class="bp">None</span>
<a name="rest_code_d698d8b9a26c435f8bb3272372adb605-6"></a><span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span> <span class="o">=</span> <span class="n">elev</span><span class="o">.</span><span class="n">shape</span>
<a name="rest_code_d698d8b9a26c435f8bb3272372adb605-7"></a><span class="n">lisflood</span><span class="o">.</span><span class="n">write_bci</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/input/arkansas.bci"</span><span class="p">,</span> <span class="n">inflows</span><span class="p">,</span> <span class="n">xul</span><span class="p">,</span> <span class="n">yul</span><span class="p">,</span> <span class="n">xres</span><span class="p">,</span> <span class="n">yres</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">)</span>
</pre>
<p>Then we generate the DEM and sub-grid channel width files.</p>
<pre class="code shell"><a name="rest_code_f4047ea185c34006bf823a5bb847bc89-1"></a><span class="nb">cd</span> ~/Work/Swot
<a name="rest_code_f4047ea185c34006bf823a5bb847bc89-2"></a>gdal_translate -tr <span class="m">1000</span> -1000 -of AAIGrid -a_nodata -9999 data/hydrosheds/arkansas_selev.tif input/arkansas.dem
<a name="rest_code_f4047ea185c34006bf823a5bb847bc89-3"></a>gdal_translate -tr <span class="m">1000</span> -1000 -of AAIGrid -a_nodata -9999 data/hydrosheds/arkansas_widths.tif input/arkansas.width
<a name="rest_code_f4047ea185c34006bf823a5bb847bc89-4"></a>gdal_translate -tr <span class="m">1000</span> -1000 -of AAIGrid -a_nodata -9999 data/hydrosheds/arkansas_bed.tif input/arkansas.bed
<a name="rest_code_f4047ea185c34006bf823a5bb847bc89-5"></a>gdal_translate -tr <span class="m">1000</span> -1000 -of AAIGrid -a_nodata -9999 -co <span class="nv">DECIMAL_PRECISION</span><span class="o">=</span><span class="m">2</span> data/hydrosheds/arkansas_initwd.tif input/arkansas.initwd
</pre>
<p>If we need LISFLOOD-FP to produce a time series of river flow at specific locations, we need to generate a virtual gauge file.</p>
<pre class="code ipython"><a name="rest_code_d4cd3ecbe5b04320b42587b65cfca3cd-1"></a><span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">10646496</span><span class="p">,</span> <span class="o">-</span><span class="mi">10281401</span><span class="p">]</span>
<a name="rest_code_d4cd3ecbe5b04320b42587b65cfca3cd-2"></a><span class="n">y</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4251469</span><span class="p">,</span> <span class="mi">4111473</span><span class="p">]</span>
<a name="rest_code_d4cd3ecbe5b04320b42587b65cfca3cd-3"></a><span class="n">lisflood</span><span class="o">.</span><span class="n">write_gauges</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">flowdir</span><span class="p">,</span> <span class="s2">"/Users/kandread/Work/Swot/data/hydrosheds/arkansas_widths.tif"</span><span class="p">,</span> <span class="s2">"/Users/kandread/Work/Swot/input/arkansas.gauge"</span><span class="p">)</span>
</pre>
<p>The final step is generating the BDY file for LISFLOOD-FP, which contains the streamflow at the inflow points (in m<sup>2</sup>/s). For this simulation we will use the output of the <a class="reference external" href="https://github.com/UW-Hydro/VIC_Routing">VIC routing model</a> forced by the <a class="reference external" href="http://ldas.gsfc.nasa.gov/nldas/NLDAS2model.php">NLDAS-2 VIC model output</a>. We need to prepare the input files for the routing model, describing the flow direction, flow fraction and station locations.
The station file is created from the inflows identified</p>
<pre class="code ipython"><a name="rest_code_97c7b2473fc84f28b4a400aa8fdf9785-1"></a><span class="kn">from</span> <span class="nn">pyproj</span> <span class="kn">import</span> <span class="n">Proj</span>
<a name="rest_code_97c7b2473fc84f28b4a400aa8fdf9785-2"></a><span class="n">wmerc</span> <span class="o">=</span> <span class="n">Proj</span><span class="p">(</span><span class="s2">"+init=EPSG:3395"</span><span class="p">)</span>
<a name="rest_code_97c7b2473fc84f28b4a400aa8fdf9785-3"></a><span class="n">fout</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">"arkansas.stations"</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span>
<a name="rest_code_97c7b2473fc84f28b4a400aa8fdf9785-4"></a><span class="k">for</span> <span class="n">sta</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inflows</span><span class="p">):</span>
<a name="rest_code_97c7b2473fc84f28b4a400aa8fdf9785-5"></a>    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">wmerc</span><span class="p">(</span><span class="n">xul</span><span class="o">+</span><span class="n">xres</span><span class="o">*</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yul</span><span class="o">+</span><span class="n">yres</span><span class="o">*</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<a name="rest_code_97c7b2473fc84f28b4a400aa8fdf9785-6"></a>    <span class="n">xi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">x</span><span class="o">+</span><span class="mf">106.625</span><span class="p">)</span><span class="o">/</span><span class="mf">0.125</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="rest_code_97c7b2473fc84f28b4a400aa8fdf9785-7"></a>    <span class="n">yi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="mf">33.375</span><span class="p">)</span><span class="o">/</span><span class="mf">0.125</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="rest_code_97c7b2473fc84f28b4a400aa8fdf9785-8"></a>    <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"1</span><span class="se">\t</span><span class="s2">AR{0:03d}</span><span class="se">\t</span><span class="s2">{1}</span><span class="se">\t</span><span class="s2">{2}</span><span class="se">\t</span><span class="s2">-9999</span><span class="se">\n</span><span class="s2">NONE</span><span class="se">\n</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">yi</span><span class="p">))</span>
<a name="rest_code_97c7b2473fc84f28b4a400aa8fdf9785-9"></a><span class="n">fout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
<p>Within GRASS GIS, we create a new region with Lat/Long projection and work within that region to create the necessary files.</p>
<pre class="code shell"><a name="rest_code_d4872f1159f240248c7c568c70b9797f-1"></a>g.proj <span class="nv">epsg</span><span class="o">=</span><span class="m">4326</span> <span class="nv">location</span><span class="o">=</span>arkansas.latlon
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-2"></a>g.mapset <span class="nv">mapset</span><span class="o">=</span>PERMANENT <span class="nv">location</span><span class="o">=</span>arkansas.latlon
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-3"></a>g.region <span class="sb">`</span>r.proj <span class="nv">location</span><span class="o">=</span>arkansas <span class="nv">mapset</span><span class="o">=</span>arkansas <span class="nv">in</span><span class="o">=</span>hydrosheds.elev -g<span class="sb">`</span>
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-4"></a><span class="c1">#g.region n=39.5 s=32.25 e=-91.875 w=-106.75 res=0:00:30</span>
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-5"></a>r.proj <span class="nv">mapset</span><span class="o">=</span>arkansas <span class="nv">location</span><span class="o">=</span>arkansas <span class="nv">in</span><span class="o">=</span>hydrosheds.felev <span class="nv">method</span><span class="o">=</span>bilinear
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-6"></a>r.proj <span class="nv">mapset</span><span class="o">=</span>arkansas <span class="nv">location</span><span class="o">=</span>arkansas <span class="nv">in</span><span class="o">=</span>basin
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-7"></a>r.mapcalc <span class="nv">exp</span><span class="o">=</span><span class="s1">'basin1=if(isnull(basin),0,1)'</span>
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-8"></a>g.region <span class="nv">res</span><span class="o">=</span><span class="m">0</span>.125 -a
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-9"></a>r.watershed -s <span class="nv">elev</span><span class="o">=</span>hydrosheds.felev <span class="nv">accum</span><span class="o">=</span>hydrosheds.flowacc <span class="nv">drain</span><span class="o">=</span>hydrosheds.flowdir <span class="nv">stream</span><span class="o">=</span>hydrosheds.river <span class="nv">threshold</span><span class="o">=</span><span class="m">15</span>
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-10"></a>r.resamp.stats <span class="nv">in</span><span class="o">=</span>basin1 <span class="nv">out</span><span class="o">=</span>fract
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-11"></a>r.reclass <span class="nv">in</span><span class="o">=</span>hydrosheds.flowdir <span class="nv">out</span><span class="o">=</span>flowdir <span class="nv">rules</span><span class="o">=</span>flowdir.rules
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-12"></a>r.mapcalc --o <span class="nv">exp</span><span class="o">=</span><span class="s1">'flowdir=flowdir'</span>
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-13"></a>r.null <span class="nv">map</span><span class="o">=</span>flowdir <span class="nv">setnull</span><span class="o">=</span><span class="m">0</span>
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-14"></a>r.null <span class="nv">map</span><span class="o">=</span>fract <span class="nv">null</span><span class="o">=</span><span class="m">0</span>
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-15"></a>r.out.gdal <span class="nv">in</span><span class="o">=</span>fract <span class="nv">out</span><span class="o">=</span>arkansas.fract <span class="nv">format</span><span class="o">=</span>AAIGrid <span class="nv">nodata</span><span class="o">=</span><span class="m">0</span>
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-16"></a>r.out.gdal <span class="nv">in</span><span class="o">=</span>flowdir <span class="nv">out</span><span class="o">=</span>arkansas.flowdir <span class="nv">format</span><span class="o">=</span>AAIGrid <span class="nv">nodata</span><span class="o">=</span><span class="m">0</span>
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-17"></a>awk <span class="s1">'BEGIN{OFS="|"}/^1/{print(-106.625+0.125*$3,33.375+0.125*$4,$2)}'</span> arkansas.stations <span class="p">|</span> v.in.ascii <span class="nv">in</span><span class="o">=</span>- <span class="nv">out</span><span class="o">=</span>inflows <span class="nv">col</span><span class="o">=</span><span class="s1">'x real,y real,name text'</span>
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-18"></a>r.stream.snap <span class="nv">in</span><span class="o">=</span>inflows <span class="nv">out</span><span class="o">=</span>stations <span class="nv">accum</span><span class="o">=</span>hydrosheds.flowacc <span class="nv">stream</span><span class="o">=</span>hydrosheds.river <span class="nv">radius</span><span class="o">=</span><span class="m">3</span>
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-19"></a>v.to.rast <span class="nv">in</span><span class="o">=</span>stations <span class="nv">out</span><span class="o">=</span>inflows <span class="nv">use</span><span class="o">=</span>cat
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-20"></a>r.stats <span class="nv">in</span><span class="o">=</span>inflows -n -x <span class="p">|</span> sort -k3 -n <span class="p">|</span> awk <span class="s1">'{printf("1\tAR%03d\t%d\t%d\t-9999\nNONE\n",$3,$1,49-$2+1)}'</span> &gt; arkansas.stations
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-21"></a>v.db.addtable <span class="nv">map</span><span class="o">=</span>stations
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-22"></a>v.db.addcolumn <span class="nv">map</span><span class="o">=</span>stations <span class="nv">col</span><span class="o">=</span><span class="s1">'flowacc real'</span>
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-23"></a>v.what.rast <span class="nv">map</span><span class="o">=</span>stations <span class="nv">raster</span><span class="o">=</span>hydrosheds.flowacc <span class="nv">column</span><span class="o">=</span>flowacc
<a name="rest_code_d4872f1159f240248c7c568c70b9797f-24"></a>v.db.select stations <span class="nv">sep</span><span class="o">=</span><span class="s2">" "</span> <span class="p">|</span> sort -k1 -n <span class="p">|</span> awk <span class="s1">'function abs(x){return ((x &lt; 0.0) ? -x : x)}NR&gt;1{print(abs($2)*157.828125)}'</span> &gt; stations.flowacc
</pre>
<p>Finally, the BDY file is written using the VIC routing model's output.</p>
<pre class="code ipython"><a name="rest_code_7dfcacacf7504111937b1800982ffa28-1"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<a name="rest_code_7dfcacacf7504111937b1800982ffa28-2"></a><span class="n">stations</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"AR{0:03d}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inflows</span><span class="p">))]</span>
<a name="rest_code_7dfcacacf7504111937b1800982ffa28-3"></a><span class="n">a0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">flowacc</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">i</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inflows</span><span class="p">])</span>
<a name="rest_code_7dfcacacf7504111937b1800982ffa28-4"></a><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s2">"stations.flowacc"</span><span class="p">)</span>
<a name="rest_code_7dfcacacf7504111937b1800982ffa28-5"></a><span class="n">area_mult</span> <span class="o">=</span> <span class="n">a0</span> <span class="o">/</span> <span class="n">a</span>
<a name="rest_code_7dfcacacf7504111937b1800982ffa28-6"></a><span class="n">lisflood</span><span class="o">.</span><span class="n">write_bdy</span><span class="p">(</span><span class="s2">"/Users/kandread/Work/Swot/input/arkansas.bdy"</span><span class="p">,</span> <span class="s2">"/Volumes/External2/nldas2"</span><span class="p">,</span> <span class="n">stations</span><span class="p">,</span> <span class="n">area_mult</span><span class="p">)</span>
</pre>
</div>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/lisflood/" rel="tag">lisflood</a></li>
            <li><a class="tag p-category" href="../../categories/swot/" rel="tag">swot</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../hello-world/" rel="prev" title="Hello world!">Previous post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="https-kandread-github-io",
            disqus_url="https://kandread.github.io/posts/Setting-up-the-LISFLOOD-FP-Arkansas-simulation/",
        disqus_title="Setting up the LISFLOOD-FP Arkansas simulation",
        disqus_identifier="cache/posts/setting-up-the-arkansas-lisflood-fp-simulation.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="https-kandread-github-io";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script><footer id="footer"><p>Contents Â© 2017         <a href="mailto:kandread@jpl.nasa.gov">Kostas Andreadis</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         </p>
            
        </footer>
</div>
    </div>
    <label for="sidebar-checkbox" class="sidebar-toggle"></label>
    
    
    
            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates -->
</body>
</html>
